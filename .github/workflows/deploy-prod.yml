name: Deploy to Azure Production Environment

on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      blue_green_percentage:
        description: 'Blue/Green deployment percentage (0-100)'
        required: false
        default: '100'
        type: number

permissions:
  contents: write
  actions: read
  checks: write

env:
  AZURE_RESOURCE_GROUP: salesoptai-container-prod
  AZURE_ACR_NAME: salesoptaiprod
  AZURE_ENVIRONMENT_NAME: salesoptai-prod-environment
  AZURE_LOCATION: canadaeast
  AZURE_KEY_VAULT_NAME: salesoptai-prod-keyvault
  PYTHON_VERSION: '3.11'

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black isort pylint
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Set Python Path
        run: |
          echo "PYTHONPATH=${{ github.workspace }}" >> $GITHUB_ENV

      - name: Run Black and isort
        run: |
          black .
          isort .

      - name: Run Pylint (errors only)
        run: |
          pylint . --errors-only || true

      - name: Commit formatting changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          if git diff --staged --quiet; then
            echo "No formatting changes needed"
          else
            git commit -m "Auto-format code with Black and isort [skip ci]"
            git push
          fi

  test:
    name: Run Tests with Coverage
    runs-on: ubuntu-latest
    needs: code-quality

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-xdist
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Set Python Path
        run: |
          echo "PYTHONPATH=${{ github.workspace }}" >> $GITHUB_ENV

      - name: Run tests with coverage (parallel)
        env:
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/testdb
          ENVIRONMENT: test
          DEBUG: true
        run: |
          pytest -v --cov=. --cov-report=term -n auto

  deploy:
    name: Build and Deploy to Azure Production
    runs-on: ubuntu-latest
    needs: test
    environment:
      name: production
      url: ${{ steps.deploy.outputs.app_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}

      - name: Set Correct Subscription Context
        run: |
          SUBSCRIPTION_ID=$(az account show --query id -o tsv)
          FOUND_SUB_ID=$(az group list --query "[?name=='${{ env.AZURE_RESOURCE_GROUP }}'].id" -o tsv | cut -d'/' -f3 | head -n 1)
          if [[ -n "$FOUND_SUB_ID" && "$FOUND_SUB_ID" != "$SUBSCRIPTION_ID" ]]; then
            echo "Resource group found in a different subscription. Switching..."
            az account set --subscription "$FOUND_SUB_ID"
          fi
          echo "Using subscription:"
          az account show --output table

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Make deployment script executable
        run: chmod +x ./deployment/deploy.sh

      - name: Deploy to Azure Container Apps (Production)
        id: deploy
        env:
          GITHUB_SHA: ${{ github.sha }}
        run: |
          cd deployment
          # Call the consolidated script with the 'prod' environment
          APP_URL=$(./deploy.sh --environment prod)
          
          echo "app_url=$APP_URL" >> $GITHUB_OUTPUT
          echo "## Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Backend URL**: $APP_URL" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Container Registry**: ${{ env.AZURE_ACR_NAME }}.azurecr.io" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ·ï¸ **Git SHA**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: Production deployment notification
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const status = '${{ job.status }}';
            const appUrl = '${{ steps.deploy.outputs.app_url }}';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            let emoji = status === 'success' ? 'âœ…' : 'âŒ';
            let message = `${emoji} **PRODUCTION** Deployment: **${status}**\n`;
            
            if (status === 'success' && appUrl) {
              message += `ðŸŒ Production Backend URL: ${appUrl}\n`;
            }
            
            message += `ðŸ“‹ [View Run](${runUrl})`;
            
            github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 0,
              state: status === 'success' ? 'success' : 'failure',
              target_url: appUrl || runUrl,
              description: `Production deployment ${status}`,
              environment: 'production'
            }).catch(() => {
              console.log('Could not create deployment status');
            });

  cleanup-on-failure:
    name: Cleanup on Failure
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}

      - name: Check and cleanup failed deployments
        run: |
          for app in "salesoptai-app-prod" "salesoptai-payment-prod"; do
            echo "Checking $app for unhealthy revisions..."
            az containerapp revision list \
              --name "$app" \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --query "[?properties.healthState=='Unhealthy'].name" -o tsv | \
            while read -r revision; do
              if [[ -n "$revision" ]]; then
                echo "Deactivating unhealthy revision: $revision"
                az containerapp revision deactivate --name "$app" --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" --revision "$revision"
              fi
            done
          done